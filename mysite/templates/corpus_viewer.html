<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark">
  <title>UN Treaty Body Database</title>

  <!-- Favicon & Analytics -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <script src="/static/js/cookies.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VFCDZ89GWR"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-VFCDZ89GWR', { 'cookie_domain': 'auto' });
  </script>

    <!-- Bootstrap, Icons & Fonts -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/unified-design-system.css') }}?v=1">

<script>
  (function () {
    try {
      var saved = localStorage.getItem('uds-theme');
      var mode = (saved === 'dark') ? 'dark' : 'light';
      var html = document.documentElement;
      html.setAttribute('data-theme', mode);
      html.dataset.mode = mode;
    } catch (e) {
      document.documentElement.setAttribute('data-theme', 'light');
      document.documentElement.dataset.mode = 'light';
    }
  })();
</script>

</head>

<body class="d-flex flex-column min-vh-100">
    {% include 'navbar_universal.html' %}

<!-- Progress bar -->
  <div id="scroll-progress-bar" class="scroll-progress-bar"></div>

<!-- Enhanced Sidebar -->
<aside class="enhanced-sidebar" id="enhancedSidebar">
  <div class="enhanced-sidebar__header">
    <h2 class="enhanced-sidebar__title">
      <i class="fas fa-balance-scale"></i>
      Treaty Body
    </h2>
    <div class="mandate-selector">
      <select id="mandateSelect" onchange="loadDocuments(this.value)">
        <option value="">Select a Treaty Body</option>
        {% for committee in committees %}
          <option value="{{ committee }}">{{ committee }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="documents-section">
    <h3 class="documents-section__title">
      <i class="fas fa-file-alt"></i>
      Documents
    </h3>
    <ul class="document-list" id="documentList">
      <!-- Document list will be populated here -->
    </ul>
  </div>
</aside>

  <!-- Main -->
  <main class="enhanced-main" id="enhancedMain">
    <div class="document-search-container" id="searchContainer">
      <div class="search-header">
        <i class="fas fa-search text-primary"></i>
        <h3>Search within Document</h3>
      </div>
      <div class="search-input-wrapper">
        <input type="text" id="documentSearchInput"
               placeholder="Type at least 3 characters to search within the selected document..."
               class="form-control">
        <i class="fas fa-search search-icon"></i>
      </div>
    </div>

    <div class="document-viewer empty" id="documentViewer">
      <div class="text-center">
        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
        <p>Select a treaty body and document to start browsing</p>
      </div>
    </div>
  </main>

  <!-- Scroll to top -->
  <button class="scroll-to-top" id="scrollToTopBtn" title="Go to top">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Mobile FAB -->
  <button class="documents-fab" id="mobileDocumentsFab" title="Browse Documents">
    <i class="fas fa-file-alt fab-icon"></i>
    <div class="fab-text">
      <span class="fab-treaty-body" id="fabTreatyBody">Select Treaty Body</span>
      <span class="fab-count" id="fabDocumentCount">0 documents</span>
    </div>
  </button>

  <!-- Mobile Panel -->
  <div class="mobile-documents-panel" id="mobileDocumentsPanel">
    <div class="mobile-documents-content">
      <div class="mobile-panel-header">
        <h3 class="mobile-panel-title"><i class="fas fa-file-alt mr-2"></i>Document Selection</h3>
        <button class="mobile-panel-close" id="closeMobilePanel"><i class="fas fa-times"></i></button>
      </div>

      <div class="mobile-committee-selector">
        <label for="mobile-committee-select" class="form-label font-weight-medium mb-2">
          <i class="fas fa-balance-scale text-primary mr-2"></i> Select Treaty Body
        </label>
        <select id="mobile-committee-select" class="form-control">
          <option value="">Choose a Committee...</option>
          {% for committee in committees %}
            <option value="{{ committee }}">{{ committee }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mobile-documents-section">
        <h4 class="mobile-documents-title">
          <i class="fas fa-list text-primary"></i> Available Documents
        </h4>
        <ul class="mobile-document-list" id="mobileDocumentList"></ul>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

 <script>
  /* =========================================================
     UN Treaty Body Corpus Viewer — Parity with SP (gold)
     Key: navbar CSS var sync, throttled progress, Ctrl+F search,
          FAB/panel behavior, theme toggle (unified).
     ========================================================= */

  /* ---------- Navbar height → CSS var (used by layout/progress) ---------- */
  function measureNavbar() {
    const nav = document.querySelector('.navbar');
    if (!nav) return 70; // fallback
    // Use layout box to include borders/shadow, not transforms
    return Math.round(nav.getBoundingClientRect().height);
  }

  function setNavbarVar(h) {
    document.documentElement.style.setProperty('--navbar-height', h + 'px');
  }

  function setBodyPadding(h) {
    // Ensure ALL pages (desktop + mobile) clear the fixed navbar
    document.body.style.paddingTop = h + 'px';
  }

  let rafToken = null;
  function syncNavbarHeightVar() {
    if (rafToken) cancelAnimationFrame(rafToken);
    rafToken = requestAnimationFrame(() => {
      const h = measureNavbar();
      setNavbarVar(h);
      setBodyPadding(h);
    });
  }

  // Expose in case page scripts call it
  window.syncNavbarHeightVar = syncNavbarHeightVar;

  // Initial sync (after DOM)
  document.addEventListener('DOMContentLoaded', syncNavbarHeightVar);

  // Re-sync on window resize
  window.addEventListener('resize', syncNavbarHeightVar, { passive: true });

  // Re-sync after fonts load (avoids jump when Inter/Open Sans render)
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(syncNavbarHeightVar).catch(()=>{});
  }

  // Re-sync after images in navbar (brand icon) load
  window.addEventListener('load', syncNavbarHeightVar);

  // Re-sync on Bootstrap navbar collapse open/close
  document.addEventListener('shown.bs.collapse', function (e) {
    if (e.target && e.target.classList.contains('navbar-collapse')) {
      syncNavbarHeightVar();
    }
  });
  document.addEventListener('hidden.bs.collapse', function (e) {
    if (e.target && e.target.classList.contains('navbar-collapse')) {
      syncNavbarHeightVar();
    }
  });

  /* ---------- Corpus Viewer ---------- */
  class EnhancedCorpusViewer {
    constructor() {
      this.currentDocumentId = null;
      this.init();
    }

    init() {
      this.setupEventListeners();
      syncNavbarHeightVar();
      window.addEventListener('resize', syncNavbarHeightVar);

      this.setupScrollProgress();
      this.setupScrollToTop();
      this.setupMobileDocuments();
      this.setupModalSearch();         // Ctrl+F overlay search
      this.loadDefaultDocuments();     // Open CRC and first doc by default
    }

    /* ============================
       SEARCH (inline + Ctrl+F)
       ============================ */
    escapeRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    highlightTextNodes(element, regex) {
      const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        {
          acceptNode(node) {
            const p = node.parentElement;
            if (p && (p.classList.contains('footnote-ref') || p.hasAttribute('data-footnote'))) {
              return NodeFilter.FILTER_REJECT;
            }
            return NodeFilter.FILTER_ACCEPT;
          }
        }
      );
      const nodes = [];
      for (let n = walker.nextNode(); n; n = walker.nextNode()) nodes.push(n);

      nodes.forEach(node => {
        const t = node.textContent;
        regex.lastIndex = 0;
        if (!regex.test(t)) return;

        regex.lastIndex = 0;
        const html = t.replace(regex, '<mark>$&</mark>');
        const span = document.createElement('span');
        span.innerHTML = html;

        const parent = node.parentNode;
        while (span.firstChild) parent.insertBefore(span.firstChild, node);
        parent.removeChild(node);
      });
    }

    documentSearch(query) {
      const viewerDiv = document.getElementById('documentViewer');
      if (!viewerDiv || viewerDiv.classList.contains('empty')) return;

      const original = viewerDiv.getAttribute('data-original') || viewerDiv.innerHTML;

      if (!query || query.trim().length < 3) {
        viewerDiv.innerHTML = original;
        const ps = viewerDiv.querySelectorAll('p');
        ps.forEach(p => p.style.display = '');
        return;
      }

      const q = query.trim();
      const regex = new RegExp(this.escapeRegex(q), 'gi');

      // Repaint with <span class="highlight"> and hide non-matching paragraphs
      viewerDiv.innerHTML = original.replace(regex, m => `<span class="highlight">${m}</span>`);
      Array.from(viewerDiv.querySelectorAll('p')).forEach(p => {
        if (!p.innerHTML.match(regex)) p.style.display = 'none';
        else p.style.display = '';
      });

      const first = viewerDiv.querySelector('.highlight');
      if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    setupModalSearch() {
      document.addEventListener('keydown', (e) => {
        const viewer = document.getElementById('documentViewer');
        if (viewer && !viewer.classList.contains('empty') && e.ctrlKey && e.key.toLowerCase() === 'f') {
          e.preventDefault();
          this.showModalSearch();
        }
      });
    }

    showModalSearch() {
      let searchBar = document.getElementById('modalSearchInput');
      if (searchBar) { searchBar.focus(); return; }

      const bar = document.createElement('div');
      bar.className = 'modal-search-bar';
      bar.innerHTML = '<input id="modalSearchInput" class="modal-search-input" placeholder="Search in document...">';

      const viewer = document.getElementById('documentViewer');
      viewer.insertBefore(bar, viewer.firstChild);

      searchBar = document.getElementById('modalSearchInput');
      searchBar.focus();

      searchBar.addEventListener('input', (e) => {
        const content = document.querySelector('#documentViewer .document-content');
        if (!content) return;

        // remove old <mark> wrappers
        content.innerHTML = content.innerHTML.replace(/<mark[^>]*>(.*?)<\/mark>/gi, '$1');

        const q = e.target.value.trim();
        if (q.length < 2) return;

        const regex = new RegExp('(' + this.escapeRegex(q) + ')', 'gi');
        this.highlightTextNodes(content, regex);
      });
    }

    /* ============================
       UI wiring
       ============================ */
    setupEventListeners() {
      // Search input (inline)
      const searchInput = document.getElementById('documentSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => this.documentSearch(e.target.value));
      }

      // Close mobile panel via ESC
      document.addEventListener('keydown', (e) => {
        const panel = document.getElementById('mobileDocumentsPanel');
        if (e.key === 'Escape' && panel && panel.style.display === 'block') {
          this.closeMobilePanel();
        }
      });
    }

    /* ============================
       Scroll progress (throttled)
       ============================ */
    setupScrollProgress() {
      const bar = document.getElementById('scroll-progress-bar');
      if (!bar) return;

      let ticking = false;

      const update = () => {
        ticking = false;
        const el = document.scrollingElement || document.documentElement;
        const max = el.scrollHeight - el.clientHeight;
        const scrolled = max > 0 ? (el.scrollTop / max) * 100 : 0;
        bar.style.width = scrolled + '%';
      };

      const onScrollOrResize = () => {
        if (!ticking) {
          ticking = true;
          requestAnimationFrame(update);
        }
      };

      update();
      window.addEventListener('scroll', onScrollOrResize, { passive: true });
      window.addEventListener('resize', onScrollOrResize, { passive: true });
    }

    /* ============================
       Scroll to top
       ============================ */
    setupScrollToTop() {
      const scrollBtn = document.getElementById('scrollToTopBtn');
      if (!scrollBtn) return;

      window.addEventListener('scroll', () => {
        if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
          scrollBtn.style.display = 'flex';
        } else {
          scrollBtn.style.display = 'none';
        }
      }, { passive: true });

      scrollBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    /* Smoothly scroll so the main/search are visible below the navbar */
    scrollToMainTop() {
      const main = document.getElementById('enhancedMain');
      const navH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--navbar-height')) || 0;
      const y = main.getBoundingClientRect().top + window.pageYOffset - (navH + 8);
      window.scrollTo({ top: Math.max(0, y), behavior: 'smooth' });
    }

    /* ============================
       Defaults & sorting
       ============================ */
    loadDefaultDocuments() {
      // Load CRC by default and open first doc (mirrors prior behavior)
      setTimeout(() => {
        window.loadDocuments('CRC', true);
      }, 100);
    }

    sortDocuments(documents) {
      // Corpus: sort “General Comment No. X” desc; fallback leaves order
      return documents.sort((a, b) => {
        const aMatch = a.name && a.name.match(/General Comment No\. (\d+)/);
        const bMatch = b.name && b.name.match(/General Comment No\. (\d+)/);
        const aNumber = aMatch ? parseInt(aMatch[1], 10) : -1;
        const bNumber = bMatch ? parseInt(bMatch[1], 10) : -1;
        return bNumber - aNumber;
      });
    }

    /* ============================
       Mobile FAB + panel
       ============================ */
    setupMobileDocuments() {
      const fab = document.getElementById('mobileDocumentsFab');
      const panel = document.getElementById('mobileDocumentsPanel');
      const closeBtn = document.getElementById('closeMobilePanel');
      const mobileSelect = document.getElementById('mobile-committee-select');

      if (!fab || !panel || !closeBtn || !mobileSelect) return;

      fab.addEventListener('click', () => {
        panel.style.display = 'block';
        document.body.style.overflow = 'hidden';
      });

      closeBtn.addEventListener('click', () => this.closeMobilePanel());
      panel.addEventListener('click', (e) => { if (e.target === panel) this.closeMobilePanel(); });

      mobileSelect.addEventListener('change', (e) => {
        this.loadMobileDocuments(e.target.value);
      });
    }

    closeMobilePanel() {
      const panel = document.getElementById('mobileDocumentsPanel');
      if (panel) {
        panel.style.display = 'none';
        document.body.style.overflow = '';
      }
    }

    loadMobileDocuments(committee) {
      if (!committee) {
        this.updateMobileDocumentList([]);
        this.updateFabDisplay('Select Treaty Body', 0);
        return;
      }

      fetch('/get_documents/' + encodeURIComponent(committee))
        .then(r => r.json())
        .then(docs => {
          const sorted = this.sortDocuments(docs);
          this.updateMobileDocumentList(sorted);
          this.updateFabDisplay(committee, sorted.length);
        })
        .catch(() => {
          this.updateMobileDocumentList([]);
          this.updateFabDisplay(committee, 0);
        });
    }

    updateMobileDocumentList(documents) {
      const mobileList = document.getElementById('mobileDocumentList');
      if (!mobileList) return;

      mobileList.innerHTML = '';
      if (!documents.length) {
        const li = document.createElement('li');
        li.innerHTML = '<p class="text-muted p-3">No documents available</p>';
        mobileList.appendChild(li);
        return;
      }

      documents.forEach(doc => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = doc.name;

        a.onclick = (e) => {
          e.preventDefault();
          viewDocument(doc.id);

          // Active state (mobile)
          document.querySelectorAll('.mobile-document-list a').forEach(n => n.classList.remove('active'));
          a.classList.add('active');

          // Mirror active state (desktop)
          document.querySelectorAll('.document-list a').forEach(n => n.classList.remove('active'));
          const desktopLink = document.querySelector(`.document-list a[onclick*="${doc.id}"]`);
          if (desktopLink) desktopLink.classList.add('active');

          this.closeMobilePanel();
        };

        li.appendChild(a);
        mobileList.appendChild(li);
      });
    }

    updateFabDisplay(label, count) {
      const fabTreatyBody = document.getElementById('fabTreatyBody');
      const fabCount = document.getElementById('fabDocumentCount');
      if (fabTreatyBody) fabTreatyBody.textContent = label;
      if (fabCount) fabCount.textContent = `${count} document${count !== 1 ? 's' : ''}`;
    }
  }

  /* ============================
     Global functions (backend hooks)
     ============================ */
  function loadDocuments(committee, viewFirstDocument = false) {
    if (!committee) return;

    fetch('/get_documents/' + encodeURIComponent(committee))
      .then(r => r.json())
      .then(documents => {
        const sorted = corpusViewer.sortDocuments(documents);
        const list = document.getElementById('documentList');
        list.innerHTML = '';

        sorted.forEach(doc => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = doc.name;
          a.onclick = (e) => {
            e.preventDefault();
            viewDocument(doc.id);
            document.querySelectorAll('.document-list a').forEach(x => x.classList.remove('active'));
            a.classList.add('active');
          };
          li.appendChild(a);
          list.appendChild(li);
        });

        // Sync mobile panel + FAB + mobile select
        corpusViewer.updateMobileDocumentList(sorted);
        corpusViewer.updateFabDisplay(committee, sorted.length);
        const mobileSelect = document.getElementById('mobile-committee-select');
        if (mobileSelect) mobileSelect.value = committee;

        // Optional: auto-open first document and ensure search is visible under navbar
        if (viewFirstDocument && sorted.length > 0) {
          corpusViewer.scrollToMainTop();
          viewDocument(sorted[0].id);
          const firstLink = document.querySelector('.document-list a');
          if (firstLink) firstLink.classList.add('active');
        }
      })
      .catch(err => {
        console.error('Error loading documents:', err);
        document.getElementById('documentList').innerHTML =
          '<li><p class="text-muted p-3">Error loading documents</p></li>';
      });
  }

  function viewDocument(documentId) {
    corpusViewer.currentDocumentId = documentId;

    // Scroll so the search field (top of main) sits below the fixed navbar
    corpusViewer.scrollToMainTop();

    const viewerDiv = document.getElementById('documentViewer');
    viewerDiv.innerHTML = `
      <div class="text-center py-5">
        <div class="enhanced-spinner enhanced-spinner--lg mb-3"></div>
        <p class="text-muted">Loading document...</p>
      </div>
    `;
    viewerDiv.classList.remove('empty');

    fetch('/get_document/' + encodeURIComponent(documentId))
      .then(r => r.json())
      .then(data => {
        let content = `
          <h2>${data.title}</h2>
          <div class="document-actions">
            <button class="action-btn" onclick="copyCitation('${data.treaty_body}', '${data.title}', '${data.adoption_date || data.adoption_year}', '${data.signature}')" title="Copy citation">
              <i class="fas fa-quote-left"></i> Copy Citation
            </button>
            ${data.link ? `<a href="${data.link}" class="action-btn secondary" target="_blank" rel="noopener" title="View source document">
              <i class="fas fa-external-link-alt"></i> Source Document
            </a>` : ''}
          </div>
          <div class="document-meta">
            <div class="copy-feedback" id="copyFeedback"></div>
            <p><strong>Signature:</strong> ${data.signature}</p>
            ${data.adoption_date ? `<p><strong>Adoption Date:</strong> ${data.adoption_date}</p>` : `<p><strong>Year of Adoption:</strong> ${data.adoption_year}</p>`}
            ${data.treaty_body ? `<p><strong>Treaty Body:</strong> ${data.treaty_body}</p>` : ''}
          </div>
          <div class="document-content">
        `;

        data.paragraphs.forEach((text, index) => {
          content += `<p>${text.replace(/^(\d+\.\s*)?/, `<strong>${index + 1}.</strong> `)}</p>`;
        });

        content += '</div>';

        viewerDiv.innerHTML = content;
        viewerDiv.setAttribute('data-original', content);

        // Clear inline search input
        const searchInput = document.getElementById('documentSearchInput');
        if (searchInput) searchInput.value = '';

        // Bring top of viewer into view (under navbar)
        viewerDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
      })
      .catch(err => {
        console.error('Error loading document:', err);
        viewerDiv.innerHTML = `
          <div class="text-center py-5 text-danger">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <p>Error loading document. Please try again.</p>
          </div>
        `;
      });
  }

  function copyCitation(treatyBody, title, adoptionDate, signature) {
    const citation = `${treatyBody}. "${title}" (${adoptionDate}), ${signature}.`;
    navigator.clipboard.writeText(citation).then(showCopyFeedback).catch(() => {
      const ta = document.createElement('textarea');
      ta.value = citation; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      showCopyFeedback();
    });
  }

  function showCopyFeedback() {
    const feedback = document.getElementById('copyFeedback');
    const button = document.querySelector('.action-btn');
    if (!feedback) return;
    feedback.classList.add('show');
    if (button) {
      button.classList.add('copy-success-animation');
      setTimeout(() => button.classList.remove('copy-success-animation'), 600);
    }
    setTimeout(() => feedback.classList.remove('show'), 2500);
  }

  /* ============================
     THEME TOGGLE (Unified)
     Note: keep your early "apply theme ASAP" snippet in <head>.
     ============================ */
  (function () {
    var STORAGE_KEY = 'uds-theme';
    var html = document.documentElement;
    var BTN_SELECTOR = '#dark-mode-toggle';

    function applyTheme(mode) {
      var effective = (mode === 'dark') ? 'dark' : 'light';
      html.setAttribute('data-theme', effective);
      html.dataset.mode = effective;

      // Optional body class for legacy rules
      if (document.body) {
        document.body.classList.toggle('dark-mode', effective === 'dark');
      }

      var btn = document.querySelector(BTN_SELECTOR);
      if (btn) {
        var icon = btn.querySelector('i');
        if (icon) icon.className = (effective === 'dark') ? 'fas fa-sun' : 'fas fa-moon';
        var target = (effective === 'dark') ? 'light' : 'dark';
        btn.setAttribute('aria-label', 'Switch to ' + target + ' mode');
        btn.setAttribute('title', 'Switch to ' + target + ' mode');
      }
    }

    try {
      var saved = localStorage.getItem(STORAGE_KEY);
      applyTheme(saved === 'dark' ? 'dark' : 'light');
    } catch (e) {
      applyTheme('light');
    }

    document.addEventListener('click', function (ev) {
      var btn = ev.target.closest(BTN_SELECTOR);
      if (!btn) return;
      ev.preventDefault();
      ev.stopPropagation();
      var next = (html.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
      try { localStorage.setItem(STORAGE_KEY, next); } catch (e) {}
      applyTheme(next);
    }, { capture: false, passive: false });
  })();

  /* ============================
     Bootstrap the viewer
     ============================ */
  let corpusViewer;
  document.addEventListener('DOMContentLoaded', () => {
    corpusViewer = new EnhancedCorpusViewer();
  });
</script>

</body>
</html>